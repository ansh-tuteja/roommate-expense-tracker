<div class="auth-page">
    <div class="form-container">
        <h2>Welcome back</h2>
        <!-- Error message display -->
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>
        
        <form id="loginForm" action="/login" method="post">
            <div class="form-group">
                <label for="email">Email address</label>
                <div class="input-wrapper">
                    
                    <input type="email" id="email" name="email" placeholder="Enter your email" required autocomplete="email" />
                </div>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                    
                    <input type="password" id="password" name="password" placeholder="Enter your password" required autocomplete="current-password" />
                </div>
            </div>
            <div class="remember-me">
                <label class="checkbox-container">
                    <input type="checkbox" name="remember" id="remember">
                    <span class="checkmark"></span>
                    Keep me signed in
                </label>
                <a href="#" class="text-link">Forgot password?</a>
            </div>
            <button type="submit" id="loginBtn" class="form-btn">
                <span class="btn-text">Sign in to ExpenseHub</span>
                <span class="btn-loader" style="display: none;">Signing in...</span>
            </button>
        </form>
        <div class="form-footer">
            <p>New to ExpenseHub? <a href="/register" class="text-link">Create account</a></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const loginForm = document.getElementById('loginForm');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const loginBtn = document.getElementById('loginBtn');
    const btnText = loginBtn.querySelector('.btn-text');
    const btnLoader = loginBtn.querySelector('.btn-loader');

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
    }

    function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
    }

    function setLoading(isLoading) {
        if (isLoading) {
            loginBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';
            loginBtn.style.opacity = '0.7';
        } else {
            loginBtn.disabled = false;
            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';
            loginBtn.style.opacity = '1';
        }
    }

    loginForm.addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent default form submission
        e.stopPropagation(); // Stop event bubbling
        
        console.log('Form submitted via AJAX'); // Debug log
        
        hideMessages();
        setLoading(true);

        const formData = new FormData(loginForm);
        
        // Convert FormData to URLSearchParams for proper form encoding
        const urlEncodedData = new URLSearchParams(formData);
        
        try {
            const response = await fetch('/login', {
                method: 'POST',
                body: urlEncodedData,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            console.log('Response received:', response.status, response.headers.get('content-type')); // Debug log

            // Try to parse JSON response
            let data;
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
                console.log('Parsed JSON data:', data); // Debug log
            } else {
                // If not JSON, treat as text (fallback for older endpoints)
                const text = await response.text();
                console.log('Received text response:', text); // Debug log
                data = { error: text };
            }

            if (response.ok && data.success) {
                showSuccess('Login successful! Redirecting...');
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = data.redirectUrl || '/dashboard';
                }, 1000);
            } else {
                // Handle different types of error responses
                let errorMessage = 'Login failed. Please try again.';
                
                if (data.error) {
                    errorMessage = data.error;
                } else if (data.message) {
                    errorMessage = data.message;
                } else if (typeof data === 'string') {
                    errorMessage = data;
                }
                
                console.log('Showing error:', errorMessage); // Debug log
                showError(errorMessage);
            }
        } catch (error) {
            console.error('Login error:', error);
            showError('Network error. Please check your connection and try again.');
        } finally {
            setLoading(false);
        }
    });

    // Clear messages when user starts typing
    document.getElementById('email').addEventListener('input', hideMessages);
    document.getElementById('password').addEventListener('input', hideMessages);
});
</script>


