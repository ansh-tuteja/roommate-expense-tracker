<div class="auth-page">
    <div class="form-container">
        <h2>Create your account</h2>
        <!-- Error message display -->
        <div id="error-message" class="error-message" style="display: none;"></div>
        <div id="success-message" class="success-message" style="display: none;"></div>
        
        <form id="registerForm" action="/register" method="post">
            <div class="form-group">
                <label for="username">Username</label>
                <div class="input-wrapper">
                    <div class="input-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"></path><circle cx="12" cy="7" r="4"></circle></svg>
                    </div>
                    <input type="text" id="username" name="username" placeholder="Choose a username" required autocomplete="username" />
                </div>
            </div>
            <div class="form-group">
                <label for="email">Email address</label>
                <div class="input-wrapper">
                    <div class="input-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><path d="M4 4h16c1.1 0 2 .9 2 2v12c0 1.1-.9 2-2 2H4c-1.1 0-2-.9-2-2V6c0-1.1.9-2 2-2z"></path><polyline points="22,6 12,13 2,6"></polyline></svg>
                    </div>
                    <input type="email" id="email" name="email" placeholder="Enter your email" required autocomplete="email" />
                </div>
            </div>
            <div class="form-group">
                <label for="password">Password</label>
                <div class="input-wrapper">
                    <div class="input-icon">
                        <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"><rect x="3" y="11" width="18" height="11" rx="2" ry="2"></rect><path d="M7 11V7a5 5 0 0 1 10 0v4"></path></svg>
                    </div>
                    <input type="password" id="password" name="password" placeholder="Create a strong password" required autocomplete="new-password" />
                </div>
                <div class="password-requirements" id="passwordHelp" style="font-size: 12px; color: var(--gray-medium); margin-top: 4px; display: none;">
                    Password must be 8-128 characters with at least one letter and one number
                </div>
            </div>
            <div class="terms-privacy">
                <p>By creating an account, you agree to our <a href="#" class="text-link">Terms of Service</a> and <a href="#" class="text-link">Privacy Policy</a>.</p>
            </div>
            <button type="submit" id="registerBtn" class="form-btn">
                <span class="btn-text">Create free account</span>
                <span class="btn-loader" style="display: none;">Creating account...</span>
            </button>
        </form>
        <div class="form-footer">
            <p>Already have an account? <a href="/login" class="text-link">Sign in</a></p>
        </div>
    </div>
</div>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const registerForm = document.getElementById('registerForm');
    const errorMessage = document.getElementById('error-message');
    const successMessage = document.getElementById('success-message');
    const registerBtn = document.getElementById('registerBtn');
    const btnText = registerBtn.querySelector('.btn-text');
    const btnLoader = registerBtn.querySelector('.btn-loader');
    const passwordInput = document.getElementById('password');
    const passwordHelp = document.getElementById('passwordHelp');

    // Check URL parameters for any error messages
    const urlParams = new URLSearchParams(window.location.search);
    const errorParam = urlParams.get('error');
    if (errorParam) {
        showError(decodeURIComponent(errorParam));
    }

    function showError(message) {
        errorMessage.textContent = message;
        errorMessage.style.display = 'block';
        successMessage.style.display = 'none';
        
        // Auto hide after 5 seconds
        setTimeout(() => {
            errorMessage.style.display = 'none';
        }, 5000);
    }

    function showSuccess(message) {
        successMessage.textContent = message;
        successMessage.style.display = 'block';
        errorMessage.style.display = 'none';
    }

    function hideMessages() {
        errorMessage.style.display = 'none';
        successMessage.style.display = 'none';
    }

    function setLoading(isLoading) {
        if (isLoading) {
            registerBtn.disabled = true;
            btnText.style.display = 'none';
            btnLoader.style.display = 'inline';
            registerBtn.style.opacity = '0.7';
        } else {
            registerBtn.disabled = false;
            btnText.style.display = 'inline';
            btnLoader.style.display = 'none';
            registerBtn.style.opacity = '1';
        }
    }

    // Show password requirements when user focuses on password field
    passwordInput.addEventListener('focus', function() {
        passwordHelp.style.display = 'block';
    });

    // Hide password requirements when user leaves password field (if valid)
    passwordInput.addEventListener('blur', function() {
        const password = passwordInput.value;
        if (password.length >= 8 && /^(?=.*[A-Za-z])(?=.*\d)/.test(password)) {
            passwordHelp.style.display = 'none';
        }
    });

    registerForm.addEventListener('submit', async function(e) {
        e.preventDefault(); // Prevent default form submission
        e.stopPropagation(); // Stop event bubbling
        
        hideMessages();
        setLoading(true);

        const formData = new FormData(registerForm);
        
        // Convert FormData to URLSearchParams for proper form encoding
        const urlEncodedData = new URLSearchParams(formData);
        
        // Debug: Log form data before sending
        console.log('Form data being sent:');
        for (let [key, value] of formData.entries()) {
            console.log(key, ':', value);
        }
        
        try {
            const response = await fetch('/register', {
                method: 'POST',
                body: urlEncodedData,
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                    'Accept': 'application/json',
                    'X-Requested-With': 'XMLHttpRequest'
                }
            });

            console.log('Response received:', response.status, response.headers.get('content-type'));

            // Try to parse JSON response
            let data;
            const contentType = response.headers.get('content-type');
            
            if (contentType && contentType.includes('application/json')) {
                data = await response.json();
                console.log('Parsed JSON data:', data);
            } else {
                // If not JSON, treat as text (fallback for older endpoints)
                const text = await response.text();
                console.log('Received text response:', text);
                data = { error: text };
            }

            if (response.ok && data.success) {
                showSuccess('Account created successfully! Redirecting...');
                // Redirect after a short delay
                setTimeout(() => {
                    window.location.href = data.redirectUrl || '/dashboard';
                }, 1500);
            } else {
                // Handle different types of error responses
                let errorMessage = 'Registration failed. Please try again.';

                if (data.error) {
                    errorMessage = typeof data.error === 'string'
                        ? data.error
                        : (data.error.message || JSON.stringify(data.error));
                } else if (data.message) {
                    errorMessage = data.message;
                } else if (typeof data === 'string') {
                    errorMessage = data;
                }

                console.log('Showing error:', errorMessage);
                showError(errorMessage);
            }
        } catch (error) {
            console.error('Registration error:', error);
            showError('Network error. Please check your connection and try again.');
        } finally {
            setLoading(false);
        }
    });

    // Clear messages when user starts typing
    document.getElementById('username').addEventListener('input', hideMessages);
    document.getElementById('email').addEventListener('input', hideMessages);
    passwordInput.addEventListener('input', hideMessages);
});
</script>


